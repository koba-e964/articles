2026 年に nix を使って dotfiles を管理する行為を始めました。

# なんで始めたの?
以下の問題意識がずっとありました:
- 環境構築に再現性がない
  - `brew` などでインストールすると最新版がインストールされる
    - バージョンの指定はできるが、更新が面倒
  - 他の人に説明ができない
    - 「一年前の自分は他人」という言葉があるが、そのとおりで自分でもどうやったかわからなくなる
- 環境のスナップショットを撮りたい
  - どの時期にどのツールのどのバージョンをインストールしていたかを
- インストールするツールに関する事項と、その設定に関する事項が別の部分に分かれる
  - 例えば `brew install git` した後、 `.gitconfig` などを別ファイルに置いてシンボリックリンクを張る、などが必要

これは環境構築に限らず、人生の他の部分でも同じでした:
- 再現性を担保したい。人生の問題をシステムで解決したい
  - 「システムで解決」するなら、自分で採用しているシステムを言葉にする必要がある
    - どうやって解決するかをログに残して、後で再利用したり応用を効かせたりしたい
- スナップショットを撮りたい
  - ログに残して、後で何がうまくいったのか振り返りたい

そのときに[2025年のdotfiles](https://zenn.dev/momeemt/articles/dotfiles2025) という記事を見つけ、以下の点に目を引かれました:
> このような要求に対しては、設定ファイルの管理ツールとパッケージマネージャが同一か、あるいは協調して動作できるソフトウェアが必要です。

> - 事前に明示されないネットワーク[1]や環境変数などへのアクセスを禁止したサンドボックス内でビルドを行います
> - 入力として指定されたオブジェクトの読み取りと、指定された出力への書き込みのみがデフォルトで許される純粋関数的なビルドを提供します

これが筆者の抱えていた問題意識とマッチしたので、nix を使いたいと思いました。

# とにかくスモールスタートを
nix を使った dotfiles を作りたいと思うとき、他の人の dotfiles を参照したいと思うかもしれません。しかし、多くの場合はその分量の多さに圧倒されてしまいます。

この記事の目的は以下の二つです。
- 基本概念を整理して、最低限どこを学べば良いかを説明する
- 開始するのに必要な準備を整理する

筆者の dotfiles のスナップショット <https://github.com/koba-e964/dotfiles/blob/2026.01.12/flake.nix> が小さい dotfiles として例になるでしょう。

# nix の学習
## メンタルモデル
nix を使うには flake.nix というファイルを定義する必要があります。flake.nix は巨大な値だと思うことができます。
- [`inputs`](https://github.com/koba-e964/dotfiles/blob/2026.01.12/flake.nix#L4-L10) と [`outputs`](https://github.com/koba-e964/dotfiles/blob/2026.01.12/flake.nix#L12-L36) を定義する必要があります。 `inputs` は参照すべきパッケージなどの入力を記述するためのもので、 `outputs` は `inputs` を受け取って値を返す無名関数です。
- パッケージのインストールなどは flake.nix に書いてある項を `nix run home-manager/master` などが解釈することによって行われます。
- 設定項目が膨大だと flake.nix が巨大になってしまいます。そのときには `import` や `imports` が使えます。
  - [`import` や `imports` は、別ファイルに書いてある値を持ってくる仕組みです。](https://zenn.dev/yasunori_kirin/articles/0014-nix_file_arrangement_tips_for_import)
    - `import` は単に値をポンと置くだけの単純な仕組みです。例えば `./git/default.nix` に `{enable=true;}` と書いてあったら、 `{git = import ./git;}` は `{git = {enable=true;};}` になります。
    - `imports` はそれより複雑です。`imports` はモジュールシステムと協調し、モジュールを取ってくる機能を持ちます。
      - 参照: <https://nixos.wiki/wiki/NixOS_modules>

### Home Manager

nix でインストールするパッケージを管理する場合は Home Manager を使うことになります。また、home.nix を定義することになります。
- home-manager をインストールする必要はありません。 flake.nix の `inputs` に書いておけば `nix run .#home-manager -- switch --flake .#default --impure` で実行できます。
- home.nix は `home/home.nix` に配置するのをよく見ます。これは[無名関数になっています](https://github.com/koba-e964/dotfiles/blob/2026.01.12/home/home.nix#L1)。
  - home.nix で色々なツールの設定をするとき、`import` を使えばファイルを分割できます。 ([参考](https://github.com/koba-e964/dotfiles/blob/2026.01.12/home/home.nix#L13-L14))

# 準備
## nix のインストール
<https://github.com/koba-e964/dotfiles/blob/2026.01.14/install.sh#L27-L29> の手順でインストールできます。
- `curl -L https://releases.nixos.org/nix/nix-${NIX_VERSION}/install | sh` をすればよいです。
- 一応念のため、ハッシュ値は以下の通りです:
  ```console
  $ curl -sSL https://releases.nixos.org/nix/nix-2.33.0/install | sha384sum
  f60a10a19cdf7d944a5b3ee2f31389319a3be55f26b82160824b20afd885fe6356e79c9cdf87dd85c44db3a12b53449c  -
  ```
- スクリプト内でインストールする場合は、インストール直後は nix コマンドが使えないので、 `source /etc/zshrc` を実行して有効化するのを忘れないようにしましょう。

## 既存の設定ファイルの移行
Home Manager では programs.zsh の initContent や envExtra を使うことで、
既存の `~/.zshrc` および `~/.zshenv` の内容をほぼそのまま移植できます。

以下の変数が使えます。
- `initContent`: alias、関数、補完設定、プラグイン読み込みなど。 `~/.zshrc` の中身をそのまま書く。
- `envExtra`: 環境変数の定義 (export PATH=... など)。 `~/.zshenv` の中身をそのまま書く。

実例: <https://github.com/koba-e964/dotfiles/blob/2026.01.09/home/home.nix#L25-L30>

# 既知の落とし穴
- experimental Nix feature 'nix-command' is disabled
  - nix の新しいサブコマンド（nix run, nix flake など）が無効になっている場合に出るエラーです。
  - コマンドライン引数に `--extra-experimental-features "nix-command flakes"` を加えるか、`~/.config/nix/nix.conf` に `experimental-features = nix-command flakes` を書いておく必要があります。
  - nix.conf は Home Manager によってインストールされる `stow` によって後から配置されるため、最初のコマンド実行時点ではまだ有効化されていません。そのため、初回だけは以下のように --extra-experimental-features を指定して実行する必要があります。
    `nix run .#home-manager --extra-experimental-features "nix-command flakes" -- switch --flake .#default --impure --extra-experimental-features "nix-command flakes"`
    - 2 箇所に追加する必要があります。これは nix に渡すオプションと、nix によって実行される `home-manager` に渡すオプションの 2 箇所です。

# この記事・この dotfiles の既知の問題
- `insecure directories`
  - 新しい環境でこれを実行すると以下のエラーが発生します。対処法はありますが dotfiles の方でどうすべきかが不明です。
  - <https://qiita.com/ayihis@github/items/88f627b2566d6341a741>
- local_python の設定を ~/.zshrc だけに入れてしまっている
  - `echo echo dummy >>~/local_python/bin/activate` を実行してダミーのファイルを作れば、 `~/.zshrc` の source 時にエラーが出なくなります。しかしこれは対症療法です。
